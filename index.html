<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Pocket Bunny</title>
    <style>
        /* Room System Styles */
        body {
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #222;
            /* Default backing */
            user-select: none;
            -webkit-user-select: none;
            touch-action: none;
        }

        #viewport {
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            position: relative;
        }

        #world-container {
            display: flex;
            width: 300vw;
            /* 3 Rooms */
            height: 100vh;
            transform: translateX(-100vw);
            /* Start at Garden (Center) */
            transition: transform 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .room {
            width: 100vw;
            height: 100vh;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            /* Buttons at bottom */
            align-items: center;
            box-sizing: border-box;
            padding-bottom: 20px;
        }

        /* Room Backgrounds */
        #room-bedroom {
            background: linear-gradient(to bottom, #cfd9df 0%, #e2ebf0 100%);
        }

        #room-bedroom.night {
            background: linear-gradient(to bottom, #0f2027, #203a43, #2c5364);
        }

        #room-garden {
            background: linear-gradient(120deg, #a1c4fd 0%, #c2e9fb 100%);
            /* Sky */
        }

        #room-stage {
            background: linear-gradient(45deg, #85FFBD 0%, #FFFB7D 100%);
        }

        #room-stage.disco {
            animation: disco-bg 2s infinite alternate;
        }

        /* Fixed Overlay Elements */
        #bunny-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;
            /* Let clicks pass to rooms */
            z-index: 10;
            width: 100vw;
            height: 100vh;
        }

        #bunny-container {
            pointer-events: auto;
            /* Re-enable clicks on bunny */
            position: relative;
            /* Center vertically manually or via flex above */
            margin-bottom: 15vh;
            /* Push up a bit */
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            touch-action: manipulation;
        }

        #bunny {
            font-size: 150px;
            cursor: pointer;
            line-height: 1;
        }

        #accessory {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 80px;
            pointer-events: none;
            z-index: 15;
        }

        /* Controls styling per room */
        .controls-group {
            display: flex;
            gap: 20px;
            margin-bottom: 50px;
            z-index: 5;
        }

        .btn {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: none;
            font-size: 40px;
            background: rgba(255, 255, 255, 0.8);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: transform 0.1s, background 0.2s;
            display: flex;
            justify-content: center;
            align-items: center;
            -webkit-tap-highlight-color: transparent;
        }

        .btn:active {
            transform: scale(0.9);
            background: rgba(255, 255, 255, 1);
        }

        /* Nav Arrows */
        .nav-arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            font-size: 40px;
            color: rgba(0, 0, 0, 0.2);
            padding: 20px;
            cursor: pointer;
            z-index: 20;
            user-select: none;
        }

        .nav-left {
            left: 10px;
        }

        .nav-right {
            right: 10px;
        }

        /* Particles & Carrots specific */
        .carrot-active {
            position: absolute;
            font-size: 60px;
            pointer-events: none;
            z-index: 5;
            line-height: 1;
        }

        #particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            pointer-events: none;
            z-index: 100;
        }

        .particle {
            position: absolute;
            font-size: 30px;
            animation: float 1.5s ease-out forwards;
        }

        @keyframes float {
            0% {
                transform: translateY(0);
                opacity: 1;
            }

            100% {
                transform: translateY(-100px);
                opacity: 0;
            }
        }

        /* Animations */
        @keyframes wiggling {
            0% {
                transform: rotate(0deg);
            }

            25% {
                transform: rotate(-10deg);
            }

            75% {
                transform: rotate(10deg);
            }

            100% {
                transform: rotate(0deg);
            }
        }

        .wiggling {
            animation: wiggling 0.5s ease-in-out;
        }

        @keyframes bouncing {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-50px);
            }
        }

        .bouncing {
            animation: bouncing 0.4s ease-in-out;
        }

        /* Disco */
        @keyframes disco-bg {
            0% {
                background: #ff00cc;
            }

            25% {
                background: #3333ff;
            }

            50% {
                background: #00ccff;
            }

            75% {
                background: #33ff33;
            }

            100% {
                background: #ffaa00;
            }
        }

        #disco-ball {
            position: absolute;
            top: -120px;
            left: 50%;
            /* Relative to Room Stage */
            transform: translateX(-50%);
            font-size: 100px;
            transition: top 0.5s;
            z-index: 4;
            pointer-events: none;
        }

        .room.disco-active #disco-ball {
            top: 20px;
            animation: spin 5s linear infinite;
        }

        @keyframes spin {
            from {
                transform: translateX(-50%) rotate(0deg);
            }

            to {
                transform: translateX(-50%) rotate(360deg);
            }
        }

        /* Animation classes */
        .spin-move {
            animation: spin-once 0.5s ease;
        }

        @keyframes spin-once {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .jump-move {
            animation: jump-once 0.3s ease;
        }

        @keyframes jump-once {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-50px);
            }
        }

        .shake-move {
            animation: shake-once 0.3s ease;
        }

        @keyframes shake-once {

            0%,
            100% {
                transform: skewX(0);
            }

            25% {
                transform: skewX(-20deg);
            }

            75% {
                transform: skewX(20deg);
            }
        }
    </style>
</head>

<body>

    <div id="particles"></div>
    <div id="viewport">
        <!-- Persistent Overlay for Bunny -->
        <div id="bunny-overlay">
            <div id="bunny-container">
                <div id="accessory"></div>
                <div id="bunny">üê∞</div>
            </div>
        </div>

        <!-- Nav Arrows -->
        <div class="nav-arrow nav-left" id="arrow-left">‚Äπ</div>
        <div class="nav-arrow nav-right" id="arrow-right">‚Ä∫</div>

        <!-- Sliding World -->
        <div id="world-container">

            <!-- Room 0: Bedroom -->
            <div id="room-bedroom" class="room">
                <div class="controls-group">
                    <button id="btn-sleep" class="btn">üåô</button>
                    <button id="btn-dress" class="btn">üé©</button>
                </div>
            </div>

            <!-- Room 1: Garden (Default) -->
            <div id="room-garden" class="room">
                <div class="controls-group">
                    <button id="btn-feed" class="btn">ü•ï</button>
                    <button id="btn-pet" class="btn">üñêÔ∏è</button>
                </div>
            </div>

            <!-- Room 2: Stage -->
            <div id="room-stage" class="room">
                <div id="disco-ball">ü™©</div>
                <div class="controls-group">
                    <button id="btn-music" class="btn">üéµ</button>
                    <!-- Instruments appear when music is on -->
                    <button id="btn-inst-1" class="btn" style="display:none">ü•Å</button>
                    <button id="btn-inst-2" class="btn" style="display:none">üéπ</button>
                    <button id="btn-inst-3" class="btn" style="display:none">üé∑</button>
                </div>
            </div>

        </div>
    </div>

    <script>
        // --- State ---
        let currentRoomIndex = 1; // 0: Bedroom, 1: Garden, 2: Stage
        let isSleeping = false;
        let isDanceMode = false;
        let audioContext = null;
        let currentAccessoryIndex = 0;
        const accessories = ['', 'üéÄ', 'üï∂Ô∏è', 'üé©'];

        // Physics State
        const carrots = []; // { x, y, vy, el, isEaten }
        const gravity = 0.8;
        const bounceDamping = 0.6;
        let bunnyX = window.innerWidth / 2; // World coordinates
        let targetBunnyX = bunnyX;

        // --- Elements ---
        const worldContainer = document.getElementById('world-container');
        const bunnyContainer = document.getElementById('bunny-container');
        const bunnyEl = document.getElementById('bunny');
        const accessoryEl = document.getElementById('accessory');
        const roomBedroom = document.getElementById('room-bedroom');
        const roomGarden = document.getElementById('room-garden');
        const roomStage = document.getElementById('room-stage');
        const particlesContainer = document.getElementById('particles');

        // Buttons
        const btnFeed = document.getElementById('btn-feed');
        const btnPet = document.getElementById('btn-pet');
        const btnSleep = document.getElementById('btn-sleep');
        const btnDress = document.getElementById('btn-dress');
        const btnMusic = document.getElementById('btn-music');

        const btnInst1 = document.getElementById('btn-inst-1');
        const btnInst2 = document.getElementById('btn-inst-2');
        const btnInst3 = document.getElementById('btn-inst-3');

        // --- Audio System ---
        function initAudio() {
            if (!audioContext) {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                audioContext = new AudioContext();
            }
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
        }

        function playTone(freq, type, duration, startTime = 0) {
            if (!audioContext) return;
            const osc = audioContext.createOscillator();
            const gain = audioContext.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, audioContext.currentTime + startTime);
            gain.gain.setValueAtTime(0.1, audioContext.currentTime + startTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + startTime + duration);
            osc.connect(gain);
            gain.connect(audioContext.destination);
            osc.start(audioContext.currentTime + startTime);
            osc.stop(audioContext.currentTime + startTime + duration);
        }

        function playSfx(type) {
            initAudio();
            if (type === 'crunch') {
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(200, audioContext.currentTime);
                osc.frequency.exponentialRampToValueAtTime(50, audioContext.currentTime + 0.1);
                gain.gain.setValueAtTime(0.1, audioContext.currentTime);
                gain.gain.linearRampToValueAtTime(0, audioContext.currentTime + 0.1);
                osc.connect(gain);
                gain.connect(audioContext.destination);
                osc.start();
                osc.stop(audioContext.currentTime + 0.1);
            } else if (type === 'giggle') {
                playTone(600, 'sine', 0.1, 0);
                playTone(800, 'sine', 0.1, 0.1);
                playTone(600, 'sine', 0.15, 0.2);
            } else if (type === 'pop') {
                playTone(400, 'sine', 0.05, 0);
            } else if (type === 'lullaby') {
                playTone(261.63, 'sine', 1, 0);
                playTone(329.63, 'sine', 1, 0.2);
                playTone(392.00, 'sine', 1, 0.4);
            }
        }

        // Instrument Sounds
        function playDrum() {
            initAudio();
            const osc = audioContext.createOscillator();
            const gain = audioContext.createGain();
            osc.frequency.setValueAtTime(150, audioContext.currentTime);
            osc.frequency.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
            gain.gain.setValueAtTime(0.5, audioContext.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
            osc.connect(gain);
            gain.connect(audioContext.destination);
            osc.start();
            osc.stop(audioContext.currentTime + 0.5);
        }
        function playPiano() {
            initAudio();
            const notes = [261.63, 293.66, 329.63, 349.23, 392.00, 440.00, 493.88, 523.25];
            const note = notes[Math.floor(Math.random() * notes.length)];
            playTone(note, 'triangle', 0.5);
        }
        function playSqueak() {
            initAudio();
            const osc = audioContext.createOscillator();
            const gain = audioContext.createGain();
            osc.frequency.setValueAtTime(800, audioContext.currentTime);
            osc.frequency.linearRampToValueAtTime(1200, audioContext.currentTime + 0.1);
            gain.gain.setValueAtTime(0.1, audioContext.currentTime);
            gain.gain.linearRampToValueAtTime(0, audioContext.currentTime + 0.1);
            osc.connect(gain);
            gain.connect(audioContext.destination);
            osc.start();
            osc.stop(audioContext.currentTime + 0.1);
        }

        // --- Visual Effects ---
        function spawnParticles(emoji, x, y) {
            const el = document.createElement('div');
            el.classList.add('particle');
            el.textContent = emoji;
            const randomX = (Math.random() - 0.5) * 50;
            if (x === undefined || y === undefined) {
                const rect = bunnyContainer.getBoundingClientRect();
                x = rect.left + rect.width / 2;
                y = rect.top + rect.height / 2;
            }
            el.style.left = (x + randomX) + 'px';
            el.style.top = y + 'px';
            particlesContainer.appendChild(el);
            setTimeout(() => { el.remove(); }, 1500);
        }

        function animateBunny(animationClass) {
            bunnyContainer.className = '';
            bunnyContainer.id = 'bunny-container';
            void bunnyContainer.offsetWidth; // Reflow
            bunnyContainer.classList.add(animationClass);
        }

        // --- Navigation ---
        function updateRoomView() {
            const offset = -currentRoomIndex * 100;
            worldContainer.style.transform = `translateX(${offset}vw)`;

            // Manage arrow visibility
            document.getElementById('arrow-left').style.display = currentRoomIndex === 0 ? 'none' : 'block';
            document.getElementById('arrow-right').style.display = currentRoomIndex === 2 ? 'none' : 'block';

            // Cleanup states
            // If leaving stage, turn off music?
            // Maybe keep it playing for fun, but UI suggests off. Let's keep state local to room.
            if (currentRoomIndex !== 2 && isDanceMode) {
                toggleDanceMode();
            }
        }

        function navigate(direction) {
            if (direction === 'left' && currentRoomIndex > 0) currentRoomIndex--;
            if (direction === 'right' && currentRoomIndex < 2) currentRoomIndex++;
            updateRoomView();
        }

        document.getElementById('arrow-left').addEventListener('click', () => navigate('left'));
        document.getElementById('arrow-right').addEventListener('click', () => navigate('right'));

        // Swipe Support
        let touchStartX = 0;
        document.addEventListener('touchstart', e => {
            touchStartX = e.changedTouches[0].screenX;
        }, { passive: false }); // passive false for some custom prevention if needed

        document.addEventListener('touchend', e => {
            const touchEndX = e.changedTouches[0].screenX;
            if (touchStartX - touchEndX > 50) navigate('right');
            if (touchEndX - touchStartX > 50) navigate('left');
        }, { passive: false });

        // --- Actions ---
        function feed() {
            playSfx('crunch');
            animateBunny('bouncing');
            spawnParticles('‚ù§Ô∏è');
        }

        function pet() {
            playSfx('giggle');
            animateBunny('wiggling');
            spawnParticles('‚ú®');
        }

        function toggleSleep() {
            isSleeping = !isSleeping;
            if (isSleeping) {
                roomBedroom.classList.add('night');
                bunnyEl.textContent = 'üò¥';
                playSfx('lullaby');
                spawnParticles('üí§');
            } else {
                roomBedroom.classList.remove('night');
                bunnyEl.textContent = 'üê∞';
                playTone(523.25, 'triangle', 0.3);
            }
        }

        function toggleAccessory() {
            currentAccessoryIndex = (currentAccessoryIndex + 1) % accessories.length;
            accessoryEl.textContent = accessories[currentAccessoryIndex];
            playSfx('pop');
            spawnParticles(accessories[currentAccessoryIndex] || 'üí®');
        }

        function toggleDanceMode() {
            isDanceMode = !isDanceMode;
            if (isDanceMode) {
                roomStage.classList.add('disco-active');
                roomStage.classList.add('disco'); // background anim
                btnMusic.style.display = 'none';
                btnInst1.style.display = 'flex';
                btnInst2.style.display = 'flex';
                btnInst3.style.display = 'flex';
                playPiano(); // intro sound
            } else {
                roomStage.classList.remove('disco-active');
                roomStage.classList.remove('disco');
                btnMusic.style.display = 'flex';
                btnInst1.style.display = 'none';
                btnInst2.style.display = 'none';
                btnInst3.style.display = 'none';
            }
        }

        // Instrument Actions
        function playInst(type) {
            if (type === 'drum') { playDrum(); animateBunny('shake-move'); spawnParticles('ü•Å'); }
            if (type === 'piano') { playPiano(); animateBunny('jump-move'); spawnParticles('üéπ'); }
            if (type === 'squeak') { playSqueak(); animateBunny('spin-move'); spawnParticles('üé∑'); }
        }

        // --- Physics (Carrot Rain) ---
        // Only active in Garden (Room 1)
        function spawnCarrot(x, y) {
            const el = document.createElement('div');
            el.classList.add('carrot-active');
            el.textContent = 'ü•ï';
            el.style.left = x + 'px';
            el.style.top = y + 'px';
            // We need to append to viewport or world?
            // Append to body so it floats over everything or room?
            // If we append to body, it doesn't move with slide.
            // Appending to room-garden ensures it stays in garden.
            document.getElementById('room-garden').appendChild(el);

            // X coordinate needs to be relative to the room for physics to look right visually?
            // Actually, if we append to room, 0,0 is top-left of room.
            // Mouse events give clientX.
            // If room is centered, clientX maps to room X?
            // currentRoomIndex 1 -> translate -100vw.
            // So Viewport X = Client X.
            // Room Garden is at X=100vw in the container.
            // So if Container is at -100vw, Garden 0 is at Viewport 0.
            // So clientX is correct for left.

            carrots.push({
                x: x, // visual x
                y: y,
                vy: 0,
                el: el,
                isEaten: false
            });
        }

        function updatePhysics() {
            if (currentRoomIndex !== 1) return; // Only process garden physics when in garden?
            // Or keep updating but don't spawn.
            // Let's pause to save performance if not visible

            for (let i = carrots.length - 1; i >= 0; i--) {
                const c = carrots[i];
                if (c.isEaten) continue;
                c.vy += gravity;
                c.y += c.vy;

                // Floor collision
                const floor = window.innerHeight - 150;
                if (c.y > floor) {
                    c.y = floor;
                    c.vy *= -bounceDamping;
                    if (Math.abs(c.vy) < 2) c.vy = 0;
                }
                c.el.style.top = c.y + 'px';
                if (c.y > window.innerHeight) { c.el.remove(); carrots.splice(i, 1); }
            }

            // Bunny Following in Garden
            let target = null;
            let nearestDist = Infinity;
            // Only follow if in garden
            if (currentRoomIndex === 1 && !isSleeping) {
                for (const c of carrots) {
                    if (Math.abs(c.vy) < 1) {
                        const dist = Math.abs(c.x - bunnyX);
                        if (dist < nearestDist) { nearestDist = dist; target = c; }
                    }
                }

                if (target) {
                    targetBunnyX = target.x;
                    // Physics Eat Check
                    if (Math.abs(target.x - bunnyX) < 50 && Math.abs(target.y - (window.innerHeight - 200)) < 100) {
                        // Check vertical roughly
                        eatCarrot(target);
                    }
                }

                // Lerp Bunny
                const speed = 0.05;
                bunnyX += (targetBunnyX - bunnyX) * speed;
                const screenCenter = window.innerWidth / 2;
                const translateX = bunnyX - screenCenter;
                bunnyContainer.style.transform = `translateX(${translateX}px)`;
            }
        }

        function eatCarrot(carrot) {
            if (carrot.isEaten) return;
            carrot.isEaten = true;
            carrot.el.remove();
            playSfx('crunch');
            animateBunny('bouncing');
            spawnParticles('‚ù§Ô∏è', carrot.x, window.innerHeight / 2); // spawn at center-ish
        }

        function gameLoop() {
            updatePhysics();
            requestAnimationFrame(gameLoop);
        }
        requestAnimationFrame(gameLoop);

        // --- Event Listeners ---
        // Room specific taps
        document.getElementById('room-garden').addEventListener('mousedown', e => {
            // Spawn logic
            if (e.target.tagName !== 'BUTTON') spawnCarrot(e.clientX, e.clientY);
        });
        document.getElementById('room-garden').addEventListener('touchstart', e => {
            if (e.target.tagName !== 'BUTTON') {
                for (let i = 0; i < e.touches.length; i++) {
                    spawnCarrot(e.touches[i].clientX, e.touches[i].clientY);
                }
            }
        }, { passive: false });

        // Button wiring
        btnFeed.addEventListener('click', feed);
        btnFeed.addEventListener('touchstart', e => { e.preventDefault(); feed(); });

        btnPet.addEventListener('click', pet);
        btnPet.addEventListener('touchstart', e => { e.preventDefault(); pet(); });

        btnSleep.addEventListener('click', toggleSleep);
        btnSleep.addEventListener('touchstart', e => { e.preventDefault(); toggleSleep(); });

        btnDress.addEventListener('click', toggleAccessory);
        btnDress.addEventListener('touchstart', e => { e.preventDefault(); toggleAccessory(); });

        btnMusic.addEventListener('click', toggleDanceMode);
        btnMusic.addEventListener('touchstart', e => { e.preventDefault(); toggleDanceMode(); });

        btnInst1.addEventListener('click', () => playInst('drum'));
        btnInst1.addEventListener('touchstart', e => { e.preventDefault(); playInst('drum'); });

        btnInst2.addEventListener('click', () => playInst('piano'));
        btnInst2.addEventListener('touchstart', e => { e.preventDefault(); playInst('piano'); });

        btnInst3.addEventListener('click', () => playInst('squeak'));
        btnInst3.addEventListener('touchstart', e => { e.preventDefault(); playInst('squeak'); });

        // Init
        document.addEventListener('click', initAudio, { once: true });
        document.addEventListener('touchstart', initAudio, { once: true });
    </script>
</body>

</html>